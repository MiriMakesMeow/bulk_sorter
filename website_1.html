<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Meine Pokémon-Karten Zählhilfe</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Comic+Relief:wght@700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root {
        --page-side: 40px;
        --dark: #423f3f;
        --card-radius: 12px;
        --card-border: 1px solid #e5e5e5;
        --card-shadow: 2px 2px 8px rgba(0, 0, 0, 0.08);
        --lead-bg: #dcdcdc;
        --ui-bg: #fafafa;
        --accent: #2e6cf6;
        --ok: #16a34a;
        --hero-top-offset: clamp(220px, 25vh, 320px);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: "Comic Relief", system-ui, -apple-system, Segoe UI, Roboto,
          Arial;
        color: #111;
      }

      .screen {
        display: none;
        min-height: 100dvh;
        background: #fff;
      }
      .screen.active {
        display: block;
      }

      .hero {
        position: relative;
        min-height: 75vh;
        display: grid;
        grid-template-columns: 1fr minmax(320px, 480px);
        align-items: start;
        gap: 2rem;
        padding: clamp(140px, 10vh, 220px) var(--page-side) 48px;
        background: url("./img/gengar.png") right 6% center / min(420px, 50vw)
            auto no-repeat,
          radial-gradient(
            ellipse at center,
            rgba(0, 0, 0, 0.15),
            rgba(0, 0, 0, 0.45)
          ),
          url("./img/background.jpg") center/cover no-repeat;
      }
      .logo {
        position: absolute;
        left: 16px;
        top: 16px;
        height: 120px;
        width: auto;
        z-index: 3;
      }
      .menu {
        position: absolute;
        right: 24px;
        top: 20px;
        z-index: 3;
        display: flex;
        gap: 18px;
        font-size: 22px;
        white-space: nowrap;
      }
      .menu a {
        color: antiquewhite;
        text-decoration: none;
      }
      .menu a:hover {
        text-decoration: underline;
      }
      .headline {
        position: absolute;
        left: 20px;
        top: 155px;
        z-index: 2;
        color: antiquewhite;
        font-size: 28px;
        text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.7);
      }
      .headline .grey {
        color: #9b9b9b;
      }

      .album {
        background: rgba(250, 250, 250, 0.35);
        backdrop-filter: blur(2px);
        border: var(--card-border);
        border-radius: var(--card-radius);
        box-shadow: var(--card-shadow);
        padding: 0.5rem 0.75rem;
        width: min(520px, 94vw);
        max-height: 48vh;
        overflow: auto;
      }
      @media (min-width: 981px) {
        .album {
          position: absolute;
          right: var(--page-side);
          top: var(--hero-top-offset);
          transform: none;
          width: auto;
          max-width: 40vw;
          min-width: 360px;
          margin: 0;
          max-height: 53vh;
          justify-self: end;
          align-self: start;
        }
      }

      .section-title {
        background: var(--dark);
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        text-decoration: underline;
        text-shadow: 2px 2px rgba(0, 0, 0, 1);
        width: max-content;
        margin: 0.5rem 0 1rem;
      }
      .select-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .select-row select {
        flex: 1 1 auto;
        padding: 0.5rem 0.75rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
      }
      .album-badge {
        background: #111;
        color: #fff;
        border-radius: 999px;
        padding: 0.25rem 0.6rem;
        font-size: 0.9rem;
      }
      .kpis {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 10px 0;
      }
      .kpi {
        background: #fff;
        border: var(--card-border);
        border-radius: 10px;
        padding: 0.6rem 0.8rem;
        box-shadow: var(--card-shadow);
        text-align: center;
        flex: 1 1 110px;
      }
      .kpi .lab {
        opacity: 0.75;
        font-size: 0.95rem;
      }
      .kpi .val {
        font-size: 1.25rem;
        font-weight: 700;
      }
      .range {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin: 0.3rem 0 1rem;
      }
      .range button {
        border: 1px solid #ddd;
        background: #eee;
        border-radius: 8px;
        padding: 0.3rem 0.6rem;
        font-weight: 700;
        cursor: pointer;
      }
      .range button.active {
        background: var(--dark);
        color: #fff;
        border-color: var(--dark);
      }
      .chart-wrap {
        background: #fff;
        border: var(--card-border);
        border-radius: var(--card-radius);
        box-shadow: var(--card-shadow);
        padding: 0.5rem;
      }
      .note {
        display: block;
        margin-top: 0.5rem;
        opacity: 0.6;
      }

      .main {
        padding: 20px var(--page-side) 24px;
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        justify-content: space-between;
        background: #fff;
      }
      .card {
        flex: 0 1 48%;
        max-width: 48%;
        background: var(--ui-bg);
        border: var(--card-border);
        border-radius: var(--card-radius);
        box-shadow: var(--card-shadow);
        padding: 14px;
        display: flex;
        flex-direction: column;
      }
      .lead {
        font-weight: 700;
        line-height: 1.3;
        font-size: 1.05rem;
        background: var(--lead-bg);
        padding: 0.5rem 0.7rem;
        border-radius: 8px;
        box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.15);
        margin: 0 0 10px;
      }
      .ebay {
        display: flex;
        gap: 14px;
        text-decoration: none;
        color: inherit;
        background: #fff;
        border: var(--card-border);
        border-radius: var(--card-radius);
        padding: 14px;
        box-shadow: var(--card-shadow);
      }
      .ebay img {
        width: 108px;
        height: 108px;
        object-fit: cover;
        border-radius: 8px;
      }
      .youtube {
        width: 100%;
        height: min(220px, 22vh);
        border-radius: var(--card-radius);
        border: var(--card-border);
      }

      @media (max-width: 980px) {
        .hero {
          grid-template-columns: 1fr;
          padding: 200px 20px 36px;
          background: url("./img/gengar.png") right 4% center / min(360px, 60vw)
              auto no-repeat,
            radial-gradient(
              ellipse at center,
              rgba(0, 0, 0, 0.15),
              rgba(0, 0, 0, 0.45)
            ),
            url("./img/background.jpg") center/cover no-repeat;
        }
        .album {
          position: static;
          transform: none;
          right: auto;
          top: auto;
          width: min(480px, 94vw);
          margin: 64px auto 0;
          max-height: 46vh;
        }
        .main {
          padding: 16px 20px;
          flex-direction: column;
        }
        .card {
          max-width: 100%;
        }
      }
      @media (max-width: 720px) {
        .menu {
          left: 16px;
          right: auto;
          top: 140px;
          gap: 12px;
          font-size: 17px;
        }
        .logo {
          height: 100px;
        }
        .headline {
          top: 185px;
        }
        .hero {
          padding-top: 210px;
          background: url("./img/gengar.png") right 2% center / min(300px, 58vw)
              auto no-repeat,
            radial-gradient(
              ellipse at center,
              rgba(0, 0, 0, 0.15),
              rgba(0, 0, 0, 0.45)
            ),
            url("./img/background.jpg") center/cover no-repeat;
        }
        .album {
          width: min(440px, 94vw);
          max-height: 44vh;
          margin-top: 72px;
        }
      }

      .search-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #fff;
        padding: 12px var(--page-side);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      }
      .search-bar {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .back {
        border: 1px solid #e5e5e5;
        background: #f6f6f6;
        border-radius: 10px;
        padding: 0.6rem 1rem;
        cursor: pointer;
      }
      .s-input-wrap {
        position: relative;
        flex: 1 1 auto;
      }
      .s-input {
        width: 100%;
        padding: 0.7rem 2.5rem 0.7rem 0.9rem;
        border: 2px solid #111;
        border-radius: 14px;
        font-size: 18px;
        outline: none;
      }
      .s-clear {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: #eef2ff;
        border: 1px solid #c7d2fe;
        color: #1d4ed8;
        font-weight: 900;
        cursor: pointer;
      }
      .filters {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px var(--page-side);
        border-bottom: 1px solid #eee;
        background: #fff;
      }
      .filters select {
        padding: 0.45rem 0.6rem;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
      }
      .results {
        padding: 20px var(--page-side) 32px;
        display: grid;
        gap: 12px;
      }
      .result-line {
        display: grid;
        grid-template-columns: 64px 1fr auto auto;
        gap: 12px;
        align-items: center;
        padding: 10px 12px;
        border: 1px solid #eee;
        border-radius: 12px;
        background: #fff;
      }
      .result-line img {
        width: 64px;
        height: 64px;
        border-radius: 8px;
        object-fit: cover;
        background: #f2f2f2;
      }
      .result-line h4 {
        margin: 0 0 4px;
        font-size: 18px;
      }
      .result-line .meta {
        opacity: 0.7;
        font-size: 13px;
      }
      .price {
        font-weight: 700;
        min-width: 90px;
        text-align: right;
      }
      .btn {
        padding: 0.5rem 0.8rem;
        border-radius: 10px;
        border: 1px solid #ddd;
        background: #eee;
        cursor: pointer;
      }
      .btn.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }
      .btn.ok {
        background: var(--ok);
        border-color: var(--ok);
        color: #fff;
      }
    </style>
  </head>
  <body>
    <!-- HOME -->
    <section id="home" class="screen active">
      <div class="hero">
        <img src="./img/logo.png" class="logo" alt="Logo" />
        <nav class="menu">
          <a href="#" data-nav="home">Home</a>
          <a href="#" data-nav="search">Kartensuche</a>
          <a href="#" data-nav="contact">Kontakt</a>
        </nav>
        <h1 class="headline">
          ...für die <span class="grey">gesamte</span> Sammlung!
        </h1>

        <div class="album" id="albumBox">
          <div class="select-row">
            <select id="albumSelect">
              <option value="domi">Domi Alt Ordner</option>
              <option value="b2">Beispielalbum 2</option>
              <option value="b3">Beispielalbum 3</option>
            </select>
            <span class="album-badge" id="albumCountBadge">0</span>
          </div>

          <h2 class="section-title" id="albumTitle">Domi Alt Ordner</h2>

          <div class="kpis">
            <div class="kpi">
              <div class="lab">Gesamtwert</div>
              <div class="val" id="kpi-total">–</div>
            </div>
            <div class="kpi">
              <div class="lab">Karten</div>
              <div class="val" id="kpi-count">0</div>
            </div>
            <div class="kpi">
              <div class="lab">Δ Zeitraum</div>
              <div class="val" id="kpi-delta">+0.0%</div>
            </div>
          </div>

          <div class="range">
            <button class="active">1M</button><button>3M</button
            ><button>6M</button><button>12M</button>
            <span style="margin-left: auto; opacity: 0.85"
              >Aktualisiert: <span id="kpi-updated">–</span></span
            >
          </div>

          <div class="chart-wrap"><canvas id="chart"></canvas></div>
          <small class="note"
            >Quelle: Bewertung deines Albums „<span id="note-album"
              >Domi Alt Ordner</span
            >“</small
          >
        </div>
      </div>

      <div class="main">
        <div class="card">
          <h2 class="section-title">Dein digitaler Cardshop</h2>
          <p class="lead">Uns findest du ab jetzt auch auf Ebay!</p>
          <a
            class="ebay"
            href="https://www.ebay.de/itm/365804384035"
            target="_blank"
            rel="noopener"
          >
            <img src="./img/evoli.webp" alt="Artikelbild" />
            <div>
              <strong>Pokémon TCG Karte Evoli Yu Nagaba Signature Rare</strong
              ><br />
              <span>Preis: 39,99€</span><br />
              <small>Weitere Angebote auf meinem eBay-Profil</small>
            </div>
          </a>
        </div>

        <div class="card">
          <h2 class="section-title">Video</h2>
          <p class="lead">
            Welche Karten sind gerade beliebt und welche eher nicht?
          </p>
          <iframe
            class="youtube"
            src="https://www.youtube.com/embed/1gRwajiEEJw"
            title="YouTube video player"
            loading="lazy"
            allowfullscreen
          ></iframe>
        </div>
      </div>
    </section>

    <!-- SEARCH -->
    <section id="search" class="screen">
      <div class="search-header">
        <div class="search-bar">
          <button class="back" data-nav="home">← Zurück</button>
          <div class="s-input-wrap">
            <input
              id="sQuery"
              type="search"
              class="s-input"
              placeholder="Karte suchen (Name, Set, Nummer) …"
            />
            <button id="sClear" class="s-clear">×</button>
          </div>
          <button id="sGo" class="btn primary">Suchen</button>
        </div>
      </div>

      <div class="filters">
        <label for="albumSelect2" style="opacity: 0.7">Ziel-Album:</label>
        <select id="albumSelect2">
          <option value="domi">Domi Alt Ordner</option>
          <option value="b2">Beispielalbum 2</option>
          <option value="b3">Beispielalbum 3</option>
        </select>
      </div>

      <div id="results" class="results"></div>
    </section>

    <script>
      /* SPA Navigation */
      const screens = {
        home: document.getElementById("home"),
        search: document.getElementById("search"),
      };
      function showScreen(name) {
        Object.values(screens).forEach((s) => s.classList.remove("active"));
        (screens[name] || screens.home).classList.add("active");
        if (name === "search")
          setTimeout(() => document.getElementById("sQuery").focus(), 50);
      }
      document.querySelectorAll("[data-nav]").forEach((a) => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          showScreen(a.dataset.nav);
        });
      });

      /* Demo-Karte für Fallbacks */
      const TEST_CARD = {
        id: "test-0001",
        name: "Pikachu (Demo)",
        set: "Demo-Set",
        number: "T-001",
        rarity: "Promo",
        image: "./img/evoli.webp",
        priceLow: 12.34,
      };

      /* --- API Layer --- */
      const API_BASE = "http://127.0.0.1:5000"; // z.B. "http://127.0.0.1:8000"
      async function http(
        path,
        { method = "GET", json, headers, ...rest } = {}
      ) {
        const res = await fetch(API_BASE + path, {
          method,
          headers: {
            ...(json ? { "Content-Type": "application/json" } : {}),
            ...headers,
          },
          body: json ? JSON.stringify(json) : undefined,
          ...rest,
        });
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`${method} ${path} → ${res.status} ${txt}`);
        }
        if (res.status === 204) return null;
        const ct = res.headers.get("content-type") || "";
        return ct.includes("application/json") ? res.json() : res.text();
      }

      const api = {
        async getAlbumCards(albumId) {
          const data = await http(
            `/album/${encodeURIComponent(albumId)}/cards`
          );
          return Array.isArray(data) ? data : [];
        },
        async addCard(albumId, cardId) {
          await http(`/album/${encodeURIComponent(albumId)}/cards`, {
            method: "POST",
            json: { id: cardId },
          });
        },
        async hasCard(albumId, cardId) {
          const cards = await this.getAlbumCards(albumId);
          return cards.some((c) => (c.id ?? c) === cardId);
        },
        async searchCards(query) {
          if (!query) return [];
          try {
            const data = await http(`/search?q=${encodeURIComponent(query)}`);
            return Array.isArray(data) ? data : [];
          } catch (err) {
            // Fallback zum Testen, wenn Backend nicht erreichbar
            const q = query.toLowerCase();
            const demo = [];
            if (q.includes("pikachu")) demo.push(TEST_CARD);
            if (q.includes("test")) demo.push(TEST_CARD);
            return demo;
          }
        },
      };

      /* HOME KPIs & Chart */
      const albumSelect = document.getElementById("albumSelect");
      const albumSelect2 = document.getElementById("albumSelect2");
      const badge = document.getElementById("albumCountBadge");
      const kpiCount = document.getElementById("kpi-count");
      const kpiTotal = document.getElementById("kpi-total");
      const kpiDelta = document.getElementById("kpi-delta");
      const kpiUpdated = document.getElementById("kpi-updated");
      const albumTitle = document.getElementById("albumTitle");
      const noteAlbum = document.getElementById("note-album");

      async function updateAlbumUI() {
        const id = albumSelect.value;
        const name = albumSelect.options[albumSelect.selectedIndex].textContent;
        albumTitle.textContent = name;
        noteAlbum.textContent = name;

        let cards = [];
        try {
          cards = await api.getAlbumCards(id);
        } catch (e) {
          /* Backend noch nicht dran → 0*/
        }
        const count = cards.length;
        badge.textContent = String(count);
        kpiCount.textContent = String(count);

        const total = cards.reduce(
          (s, c) => s + (typeof c.priceLow === "number" ? c.priceLow : 0),
          0
        );
        kpiTotal.textContent = total.toFixed(2).replace(".", ",") + " €";

        kpiDelta.textContent = (Math.random() * 3 - 1).toFixed(1) + "%";
        kpiUpdated.textContent = new Date().toLocaleDateString();
      }

      albumSelect.addEventListener("change", async () => {
        albumSelect2.value = albumSelect.value;
        await updateAlbumUI();
        await refreshSearchButtonsState?.();
      });

      // Chart (Dummy)
      const chart = new Chart(
        document.getElementById("chart").getContext("2d"),
        {
          type: "line",
          data: {
            labels: ["-12M", "-9M", "-6M", "-3M", "Jetzt"],
            datasets: [
              {
                label: "Wertentwicklung",
                data: [11000, 11500, 11800, 12150, 12300],
                borderColor: "#333",
                backgroundColor: "rgba(0,0,0,.12)",
                pointBackgroundColor: "#333",
                borderWidth: 2,
                tension: 0.3,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { font: { size: 12 } } },
              y: { ticks: { font: { size: 12 } } },
            },
          },
        }
      );

      /* SEARCH */
      const sQuery = document.getElementById("sQuery");
      const sClear = document.getElementById("sClear");
      const sGo = document.getElementById("sGo");
      const results = document.getElementById("results");

      function resultRowHtml(c, disabled) {
        return `
          <div class="result-line">
            <img src="${c.image || ""}" alt="">
            <div>
              <h4>${c.name}</h4>
              <div class="meta">${c.set || ""}${
          c.number ? " · #" + c.number : ""
        }${c.rarity ? " · " + c.rarity : ""}</div>
            </div>
            <div class="price">${(c.priceLow ?? 0).toFixed(2)} €</div>
            <button class="btn ${disabled ? "ok" : ""} btn-add" data-id="${
          c.id
        }" ${disabled ? "disabled" : ""}>
              ${disabled ? "Hinzugefügt" : "Zu Album"}
            </button>
          </div>`;
      }

      async function renderSearch(items) {
        const aid = albumSelect2.value;
        if (!items.length) {
          results.innerHTML = `<div style="grid-column:1/-1;padding:8px;color:#666">Keine Treffer</div>`;
          return;
        }
        const flags = await Promise.all(
          items.map((it) => api.hasCard(aid, it.id).catch(() => false))
        );
        results.innerHTML = items
          .map((it, i) => resultRowHtml(it, flags[i]))
          .join("");
        results.querySelectorAll(".btn-add").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            btn.disabled = true;
            btn.textContent = "...";
            try {
              await api.addCard(aid, id);
              btn.classList.add("ok");
              btn.textContent = "Hinzugefügt";
            } catch {
              btn.disabled = false;
              btn.textContent = "Fehler";
            }
            await updateAlbumUI();
          });
        });
      }

      async function doSearch() {
        const q = sQuery.value.trim();
        if (!q) {
          results.innerHTML = "";
          return;
        }
        try {
          const items = await api.searchCards(q);
          await renderSearch(items);
        } catch (err) {
          results.innerHTML = `<div style="grid-column:1/-1;padding:8px;color:#c00">Suche fehlgeschlagen: ${err.message}</div>`;
        }
      }

      sGo.addEventListener("click", doSearch);
      sClear.addEventListener("click", () => {
        sQuery.value = "";
        sQuery.focus();
        doSearch();
      });
      sQuery.addEventListener("keydown", (e) => {
        if (e.key === "Enter") doSearch();
      });

      async function refreshSearchButtonsState() {
        const aid = albumSelect2.value;
        const btns = results.querySelectorAll(".btn-add[data-id]");
        for (const btn of btns) {
          const inAlbum = await api
            .hasCard(aid, btn.dataset.id)
            .catch(() => false);
          btn.disabled = inAlbum;
          btn.classList.toggle("ok", inAlbum);
          btn.textContent = inAlbum ? "Hinzugefügt" : "Zu Album";
        }
      }

      // INIT
      (async function init() {
        albumSelect2.value = albumSelect.value; // Dropdowns synchron
        await updateAlbumUI(); // KPIs initial
        showScreen("home");
      })();
    </script>
  </body>
</html>
